<a-scene mindar-image="imageTargetSrc: travel-target.mind; autoStart: true;" embedded>
  <a-camera position="0 0 0"></a-camera>
</a-scene>

<div id="ui" style="display:none;">
  <span id="score">分數：0</span>
  <span id="timer">時間：30</span>
</div>
<canvas id="gameCanvas" width="400" height="600" style="display:none;"></canvas>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const ui = document.getElementById("ui");
const scoreEl = document.getElementById("score");
const timerEl = document.getElementById("timer");

const realMovies = ["無間道", "花樣年華", "甜蜜蜜", "重慶森林", "功夫", "英雄本色"];
const fakeMovies = ["夢幻追擊", "光影密碼", "午夜之塔", "銀河風暴", "藍天行動"];
let stars = [];
let score = 0;
let timeLeft = 30;
let gameRunning = false;
let spawnTimeout = null;
let countdownInterval = null;

// 隨機生成星星
function randomMovie() {
  const isReal = Math.random() > 0.5;
  const name = isReal
    ? realMovies[Math.floor(Math.random() * realMovies.length)]
    : fakeMovies[Math.floor(Math.random() * fakeMovies.length)];
  const x = Math.random() * (canvas.width - 100) + 20;
  const color = isReal ? "#FFD700" : "#FF69B4";
  stars.push({ name, x, y: 0, speed: Math.random() * 2 + 1.5, isReal, color });
}

// 畫面更新
function draw() {
  if(!gameRunning) return;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.font = "20px Noto Sans TC";
  stars.forEach(star => {
    ctx.fillStyle = star.color;
    ctx.fillText(star.name, star.x, star.y);
    star.y += star.speed;
  });
  // 移除落到畫面外的星星
  for (let i = stars.length - 1; i >= 0; i--) {
    if (stars[i].y > canvas.height + 20) stars.splice(i, 1);
  }
  requestAnimationFrame(draw);
}

// 生成星星 loop
function spawnLoop() {
  if(!gameRunning) return;
  randomMovie();
  spawnTimeout = setTimeout(spawnLoop, 800);
}

// 計時器
function countdown() {
  countdownInterval = setInterval(() => {
    timeLeft--;
    timerEl.textContent = `時間：${timeLeft}`;
    if(timeLeft <= 0) stopGame();
  }, 1000);
}

// 開始遊戲
function startGame() {
  if(gameRunning) return;
  score = 0;
  timeLeft = 30;
  stars = [];
  scoreEl.textContent = `分數：${score}`;
  timerEl.textContent = `時間：${timeLeft}`;
  gameRunning = true;
  ui.style.display = "block";
  canvas.style.display = "block";
  draw();
  spawnLoop();
  countdown();
}

// 停止遊戲 / 離開 marker
function stopGame() {
  gameRunning = false;
  ui.style.display = "none";
  canvas.style.display = "none";
  stars = [];
  clearTimeout(spawnTimeout);
  clearInterval(countdownInterval);
}

// click 判定文字
window.addEventListener("click", (e) => {
  if(!gameRunning) return;
  const x = e.clientX - canvas.getBoundingClientRect().left;
  const y = e.clientY - canvas.getBoundingClientRect().top;

  for (let i = stars.length - 1; i >= 0; i--) {
    const star = stars[i];
    const textWidth = ctx.measureText(star.name).width;
    const textHeight = 24;
    const padding = 5;
    if(x > star.x - padding && x < star.x + textWidth + padding &&
       y > star.y - textHeight - padding && y < star.y + padding) {
      if(star.isReal) score += 10;
      else score -= 5;
      scoreEl.textContent = `分數：${score}`;
      stars.splice(i,1);
      break;
    }
  }
});

// 偵測 marker
const markerEl = document.querySelector("#checkpoint-0"); // 你 marker ID
markerEl.addEventListener("targetFound", startGame);
markerEl.addEventListener("targetLost", stopGame);
</script>
